<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Switch UI</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#000000">

<link rel="manifest" href="manifest.json">
<link rel="icon" type="image/png" href="favicon.png">

<style>
html,body{margin:0;width:100%;height:100%;background:#000;overflow:hidden;}
canvas{display:block;}
</style>
</head>
<body>
<canvas id="c"></canvas>

<script>
const c=document.getElementById("c");
const ctx=c.getContext("2d");
const buffer=document.createElement("canvas");
const bctx=buffer.getContext("2d");
function resize(){c.width=innerWidth;c.height=innerHeight;buffer.width=c.width;buffer.height=c.height;}
window.addEventListener("resize",resize); resize();

function easeOutCubic(t){return 1-Math.pow(1-t,3);}

// --- アイコン ---
const apps=[
  {name:"ゲーム", icon:new Image()},
  {name:"設定", icon:new Image()},
  {name:"アルバム", icon:new Image()},
  {name:"電源", icon:new Image()}
];
// 自作PNGに置き換え
apps[0].icon.src="game.png";
apps[1].icon.src="settings.png";
apps[2].icon.src="album.png";
apps[3].icon.src="power.png";

// --- 状態 ---
let state="home";
let selected=0,pos=0,vel=0,fade=0,timer=0;
let spin=0,spinSpeed=0;
const spacing=220;

// 選択アイコン拡大アニメーション
let scales = Array(apps.length).fill(1);
const scaleTarget = 1.35;
let launchZoom = 1;

// --- 描画 ---
function drawHome(t){
  const cx=c.width/2,cy=c.height/2;
  const tp=selected*spacing;
  vel=(vel+(tp-pos)*0.12)*0.75; pos+=vel;

  for(let i=0;i<apps.length;i++){
    const target = (i===selected) ? scaleTarget : 1;
    scales[i] += (target - scales[i])*0.1;

    const x=cx+i*spacing-pos;
    const s=scales[i]*((state==="launching") ? launchZoom : 1);

    t.save(); t.translate(x,cy); t.scale(s,s);
    if(i===selected){ t.shadowColor="#0ff"; t.shadowBlur=30; }

    // 画像がまだ読み込まれていない場合は空キャンバスを描画
    if(apps[i].icon.complete){
      t.drawImage(apps[i].icon,-80,-80,160,160);
    } else {
      t.fillStyle="#444"; // 読み込み前の灰色アイコン
      t.fillRect(-80,-80,160,160);
    }

    t.restore();

    if(i===selected){
      t.fillStyle="#fff"; t.font="24px sans-serif"; t.textAlign="center";
      t.fillText(apps[i].name,x,cy+140);
    }
  }
}

function drawLoading(){
  bctx.clearRect(0,0,c.width,c.height); drawHome(bctx);
  ctx.filter="blur(12px)"; ctx.drawImage(buffer,0,0); ctx.filter="none";
  ctx.fillStyle="rgba(0,0,0,0.35)"; ctx.fillRect(0,0,c.width,c.height);

  ctx.fillStyle="#fff"; ctx.font="28px sans-serif"; ctx.textAlign="center";
  ctx.fillText(apps[selected].name+" を起動しています",c.width/2,c.height/2-80);

  const cx=c.width/2,cy=c.height/2,R=32,r=5,N=8;
  spinSpeed += (0.08 - spinSpeed)*0.08; spin += spinSpeed;
  for(let i=0;i<N;i++){
    const a = spin + i*(Math.PI*2/N);
    ctx.globalAlpha = 0.3 + (i/N)*0.7;
    ctx.beginPath(); ctx.arc(cx+Math.cos(a)*R,cy+Math.sin(a)*R,r,0,Math.PI*2); ctx.fill();
  }
  ctx.globalAlpha = 1;
}

function drawApp(){
  ctx.fillStyle="#111"; ctx.fillRect(0,0,c.width,c.height);
  ctx.fillStyle="#fff"; ctx.font="48px sans-serif"; ctx.textAlign="center";
  ctx.fillText(apps[selected].name,c.width/2,c.height/2);
  ctx.font="20px sans-serif"; ctx.fillText("EscでHOMEに戻る",c.width/2,c.height/2+60);
}

// --- メインループ ---
function loop(){
  ctx.clearRect(0,0,c.width,c.height);

  if(state==="home") drawHome(ctx);

  if(state==="launching"){
    drawHome(ctx);
    launchZoom += (1.6 - launchZoom)*0.1;
    fade += 0.05;
    ctx.fillStyle=`rgba(0,0,0,${fade})`; ctx.fillRect(0,0,c.width,c.height);
    if(fade>=1){state="loading"; timer=0; launchZoom=1; fade=0;}
  }

  if(state==="loading"){ drawLoading(); timer++; if(timer>90){state="app"; timer=0;} }

  if(state==="app") drawApp();

  if(state==="returning"){
    drawHome(ctx);
    timer++;
    const t=Math.min(timer/25,1);
    const e=easeOutCubic(t);
    launchZoom = 1.6 - 0.6*e;
    ctx.fillStyle=`rgba(0,0,0,${1-e})`;
    ctx.fillRect(0,0,c.width,c.height);
    if(t>=1){state="home"; timer=0; launchZoom=1;}
  }

  requestAnimationFrame(loop);
}

// --- ループ開始 ---
loop(); // 即開始、画像未ロードでも灰色枠で仮描画される

// --- キー操作 ---
window.addEventListener("keydown",e=>{
  if(state==="home"){
    if(e.key==="ArrowRight") selected=(selected+1)%apps.length;
    if(e.key==="ArrowLeft") selected=(selected-1+apps.length)%apps.length;
    if(e.key==="Enter"){state="launching"; fade=0; timer=0; launchZoom=1;}
  } else if(state==="app" && e.key==="Escape"){
    state="returning"; timer=0;
  }
});
</script>
</body>
</html>
