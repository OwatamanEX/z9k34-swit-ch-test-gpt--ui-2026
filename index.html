<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Danmaku Space</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<style>
html,body{margin:0;width:100%;height:100%;background:#000;overflow:hidden;}
canvas{display:block;}
</style>
</head>
<body>
<canvas id="c"></canvas>

<script>
/* ================= 基本 ================= */
const c=document.getElementById("c");
const ctx=c.getContext("2d");
function resize(){c.width=innerWidth;c.height=innerHeight;}
addEventListener("resize",resize);resize();

const keys={};
addEventListener("keydown",e=>keys[e.key]=true);
addEventListener("keyup",e=>keys[e.key]=false);

/* ================= 自機描画 ================= */
function drawPlayer(x,y){
  ctx.save();
  ctx.translate(x,y);
  ctx.fillStyle="#0ff";
  ctx.beginPath();
  ctx.moveTo(0,-18);
  ctx.lineTo(12,14);
  ctx.lineTo(0,8);
  ctx.lineTo(-12,14);
  ctx.closePath();
  ctx.fill();

  ctx.strokeStyle="#fff";
  ctx.beginPath();
  ctx.arc(0,0,5,0,Math.PI*2); // 当たり判定
  ctx.stroke();
  ctx.restore();
}

/* ================= 弾描画 ================= */
function drawBullet(b){
  ctx.save();
  ctx.translate(b.x,b.y);
  ctx.rotate(b.a);
  ctx.fillStyle="#f55";
  ctx.beginPath();
  ctx.moveTo(0,-6);
  ctx.lineTo(3,6);
  ctx.lineTo(-3,6);
  ctx.closePath();
  ctx.fill();
  ctx.restore();
}

/* ================= ゲーム状態 ================= */
let px,py,vx,vy;
let bullets=[];
let time=0;
let gameOver=false;

const hitR=5;
const hiKey="space_danmaku_hi";
let highScore=Number(localStorage.getItem(hiKey)||0);

function start(){
  px=c.width/2;
  py=c.height*0.8;
  vx=vy=0;
  bullets=[];
  time=0;
  gameOver=false;
}

/* ================= 弾幕生成 ================= */
function spawn(){
  const level=time/600;
  const rings=2+Math.floor(level);
  const perRing=16+Math.floor(level*6);
  const baseSpeed=4+level*1.2;

  for(let r=0;r<rings;r++){
    for(let i=0;i<perRing;i++){
      const a=i*(Math.PI*2/perRing)+time*0.02*(r%2?1:-1);
      bullets.push({
        x:c.width/2,
        y:120,
        vx:Math.cos(a)*(baseSpeed+r),
        vy:Math.sin(a)*(baseSpeed+r),
        a
      });
    }
  }
}

/* ================= メイン描画 ================= */
function draw(){
  time++;
  ctx.fillStyle="#000";
  ctx.fillRect(0,0,c.width,c.height);

  /* ===== 入力＆移動（高速＆滑らか） ===== */
  const accel=0.8;
  if(keys.ArrowLeft) vx-=accel;
  if(keys.ArrowRight) vx+=accel;
  if(keys.ArrowUp) vy-=accel;
  if(keys.ArrowDown) vy+=accel;

  vx*=0.92; vy*=0.92;
  const max=9;
  vx=Math.max(-max,Math.min(max,vx));
  vy=Math.max(-max,Math.min(max,vy));

  px+=vx; py+=vy;
  px=Math.max(20,Math.min(c.width-20,px));
  py=Math.max(20,Math.min(c.height-20,py));

  drawPlayer(px,py);

  /* ===== 弾幕 ===== */
  if(time%20===0) spawn();

  for(const b of bullets){
    b.x+=b.vx;
    b.y+=b.vy;
    drawBullet(b);

    const dx=b.x-px,dy=b.y-py;
    if(Math.hypot(dx,dy)<hitR+4){
      gameOver=true;
    }
  }
  bullets=bullets.filter(b=>
    b.x>-100&&b.x<c.width+100&&b.y>-100&&b.y<c.height+100
  );

  /* ===== UI ===== */
  const score=Math.floor(time/60);
  ctx.fillStyle="#fff";
  ctx.font="18px sans-serif";
  ctx.textAlign="left";
  ctx.fillText("SCORE "+score,20,30);
  ctx.fillText("HI "+highScore,20,55);

  if(gameOver){
    if(score>highScore){
      highScore=score;
      localStorage.setItem(hiKey,highScore);
    }
    ctx.fillStyle="rgba(0,0,0,0.75)";
    ctx.fillRect(0,0,c.width,c.height);
    ctx.fillStyle="#fff";
    ctx.font="40px sans-serif";
    ctx.textAlign="center";
    ctx.fillText("GAME OVER",c.width/2,c.height/2);
    ctx.font="20px sans-serif";
    ctx.fillText("Enter: 再開",c.width/2,c.height/2+50);
  }
}

/* ================= ループ ================= */
function loop(){
  if(!gameOver) draw();
  requestAnimationFrame(loop);
}
start(); loop();

addEventListener("keydown",e=>{
  if(gameOver && e.key==="Enter") start();
});
</script>
</body>
</html>
